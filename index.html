<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Car Sharing Planner (Simple)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f7f7f7; }
    h2 { margin-top: 1em; }
    .box { background: white; padding: 10px; margin: 10px 0; border-radius: 5px; }
    label { display: block; margin: 5px 0; }
    input, select { margin-left: 5px; }
    button { margin-top: 5px; }
    pre { background: #eee; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>
<body>

<h1>Car Sharing Planner</h1>

<div class="box">
  <h2>People</h2>
  <label>Name: <input id="personName"></label>
  <label>Has car: <input type="checkbox" id="personCar"></label>
  <button onclick="addPerson()">Add Person</button>
  <ul id="peopleList"></ul>
</div>

<div class="box">
  <h2>Shifts</h2>
  <label>Day: <input id="dayName"></label>
  <label>Person: <select id="shiftPerson"></select></label>
  <label>Start: <input id="shiftStart" placeholder="e.g. 07:45"></label>
  <label>End: <input id="shiftEnd" placeholder="e.g. 12:45"></label>
  <button onclick="addShift()">Add Shift</button>
  <ul id="shiftList"></ul>
</div>

<div class="box">
  <h2>Plan</h2>
  <label>Car capacity: <input id="capacity" value="4" type="number" min="1"></label>
  <button onclick="generatePlan()">Generate Plan</button>
  <pre id="output"></pre>
</div>

<script>
const state = { people: [], shifts: [] };

function refreshPeople() {
  const ul = document.getElementById("peopleList");
  const sel = document.getElementById("shiftPerson");
  ul.innerHTML = '';
  sel.innerHTML = '';
  for (const p of state.people) {
    ul.innerHTML += `<li>${p.name} ${p.hasCar ? '(ðŸš—)' : ''}</li>`;
    sel.innerHTML += `<option value="${p.name}">${p.name}</option>`;
  }
}

function addPerson() {
  const name = document.getElementById("personName").value.trim();
  const hasCar = document.getElementById("personCar").checked;
  if (!name) return alert("Enter a name");
  if (state.people.some(p => p.name === name)) return alert("Already exists");
  state.people.push({ name, hasCar });
  refreshPeople();
}

function refreshShifts() {
  const ul = document.getElementById("shiftList");
  ul.innerHTML = '';
  for (const s of state.shifts) {
    ul.innerHTML += `<li>${s.day}: ${s.person} ${s.start}â†’${s.end}</li>`;
  }
}

function addShift() {
  const person = document.getElementById("shiftPerson").value;
  const day = document.getElementById("dayName").value.trim();
  const start = document.getElementById("shiftStart").value.trim();
  const end = document.getElementById("shiftEnd").value.trim();
  if (!day || !person || !start || !end) return alert("Fill all fields");
  state.shifts.push({ day, person, start, end });
  refreshShifts();
}

function groupBy(arr, key) {
  const out = {};
  for (const a of arr) {
    const k = key(a);
    if (!out[k]) out[k] = [];
    out[k].push(a);
  }
  return out;
}

function generatePlan() {
  const cap = Math.max(1, parseInt(document.getElementById("capacity").value));
  const out = document.getElementById("output");
  if (!state.shifts.length) return out.textContent = "No shifts.";
  let result = "";

  const byDay = groupBy(state.shifts, s => s.day);
  for (const [day, shifts] of Object.entries(byDay)) {
    result += `=== ${day} ===\n`;

    const hasCar = Object.fromEntries(state.people.map(p => [p.name, p.hasCar]));

    // Compute minimal set of drivers covering starts and ends
    const byStart = groupBy(shifts, s => s.start);
    const byEnd   = groupBy(shifts, s => s.end);

    const needStart = Object.fromEntries(Object.entries(byStart).map(([k,v]) => [k, Math.ceil(v.length / cap)]));
    const needEnd   = Object.fromEntries(Object.entries(byEnd).map(([k,v]) => [k, Math.ceil(v.length / cap)]));

    const startOf = Object.fromEntries(shifts.map(s => [s.person, s.start]));
    const endOf   = Object.fromEntries(shifts.map(s => [s.person, s.end]));

    const drivers = new Set();
    function remaining() {
      return Object.values(needStart).some(v=>v>0) || Object.values(needEnd).some(v=>v>0);
    }
    while (remaining()) {
      let best = null, bestGain = 0;
      for (const s of shifts) {
        const p = s.person;
        if (!hasCar[p] || drivers.has(p)) continue;
        const gain = (needStart[startOf[p]]>0?1:0) + (needEnd[endOf[p]]>0?1:0);
        if (gain > bestGain) { best = p; bestGain = gain; }
      }
      if (!best) break;
      drivers.add(best);
      needStart[startOf[best]] = Math.max(0, needStart[startOf[best]]-1);
      needEnd[endOf[best]]     = Math.max(0, needEnd[endOf[best]]-1);
    }

    const assign = (groups) => {
      const cars = {};
      for (const [k, arr] of Object.entries(groups)) {
        const members = arr.map(x => x.person);
        const localDrivers = members.filter(m => drivers.has(m));
        const carList = localDrivers.map(d => ({ driver: d, passengers: [] }));
        const others = members.filter(m => !drivers.has(m));
        let ci = 0;
        for (const p of others) {
          if (!carList.length) carList.push({ driver: p, passengers: [] });
          const c = carList[ci];
          if (c.passengers.length < cap-1) c.passengers.push(p);
          else { carList.push({ driver: p, passengers: [] }); ci = carList.length-1; }
          ci = (ci + 1) % carList.length;
        }
        cars[k] = carList;
      }
      return cars;
    };

    const morning = assign(byStart);
    const evening = assign(byEnd);

    for (const [start, cars] of Object.entries(morning)) {
      result += `Start ${start}:\n`;
      for (const c of cars) {
        result += `  ðŸš— ${c.driver} -> [${c.passengers.join(', ') || 'â€”'}]\n`;
      }
    }
    for (const [end, cars] of Object.entries(evening)) {
      result += `Return ${end}:\n`;
      for (const c of cars) {
        result += `  ðŸš— ${c.driver} -> [${c.passengers.join(', ') || 'â€”'}]\n`;
      }
    }
    result += "\n";
  }

  out.textContent = result;
}
</script>
</body>
</html>
